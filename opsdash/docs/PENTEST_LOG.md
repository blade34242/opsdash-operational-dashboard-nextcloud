# Opsdash Pentest Log — 2025-11-10

All commands executed from repo root (unless noted). Credentials:
- `admin:admin`
- `pentester:pentest` (created via `occ` for multi-user isolation tests).

> Note: The scripts referenced below (`tools/security/run_curl_checks.sh`,
> `tools/security/import_fuzz.sh`, `opsdash/tools/security/run_notes_csrf.sh`)
> run manually during pentests; they are not part of the default CI pipeline.

## 1. Baseline & Input Clamps

| Test | Command | Result |
| ---- | ------- | ------ |
| Invalid `range` clamped to `week` | `curl -s -u admin:admin -H 'OCS-APIREQUEST: true' 'http://localhost:8088/index.php/apps/opsdash/overview/load?range=year&offset=0' \\| jq '.meta.range'` | Response `"week"` (server rejects unsupported range). |
| Oversized `offset` clamped | `curl -s -u admin:admin -H 'OCS-APIREQUEST: true' '...offset=999' \\| jq '.meta.offset'` | Response `24` (server max +/-24). |
| Unauthenticated load blocked | `curl -i '.../overview/load?range=week&offset=0'` | `401 Unauthorized`. |
| POST `/persist` without `OCS-APIREQUEST` header | `curl -i -s -u admin:admin -H 'Content-Type: application/json' -X POST ... --data '{}'` | `412 Precondition failed` (CSRF/OCS guard). |

## 2. `/persist` Fuzz

Payload (`fuzz.json`) attempted negative targets, huge totals, invalid `theme_preference`, and HTML in category IDs:
```json
{
  "cals": ["personal"],
  "groups": {"personal": 999},
  "targets_week": {"personal": -123},
  "targets_month": {"personal": 987654321},
  "targets_config": {
    "categories": [
      {"id": "<script>alert(1)</script>", "label": "<img src=x onerror=alert(1)>", "targetHours": -50, "includeWeekend": true}
    ],
    "totalHours": 100000,
    "balance": {"ui": {"showNotes": true}}
  },
  "theme_preference": "purple"
}
```
Command:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST 'http://localhost:8088/index.php/apps/opsdash/overview/persist' \
  --data @fuzz.json | jq '.'
```
Findings:
- Numeric clamps engaged (`targets_week`→0, `targets_month`→10000, `totalHours`→10000).
- Invalid `theme_preference` ignored (remains `auto`).
- HTML payload stored verbatim; SPA escapes at render time (no execution observed).

## 3. Presets Endpoint

`preset_payload.json` (`name = "evil<script>"`) saved successfully:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST '.../overview/presets' --data @preset_payload.json
```

Prior to the 0.4.5 fix, loading via `/overview/presets/evil%3Cscript%3E` returned
HTTP 500. The new sanitiser strips HTML/path characters so the preset is stored
as `evilscript`. Follow-up GET/DELETE succeed and the automation script asserts
this behaviour on every run.

## 4. Multi-user Isolation

Created second user:
```
docker exec nc31-dev sh -c 'OC_PASS=pentest php occ user:add \
  --password-from-env --display-name="Pentester" --email="pentester@example.com" pentester'
```

| Test | Result |
| ---- | ------ |
| `pentester` `/overview/load` | Returns `1` calendar (personal only), confirming empty config. |
| `pentester` `/overview/persist` (custom payload) | `{"ok":true}`; only their dataset changes. |
| Re-fetch `admin` | Still shows 8 calendars + original config, demonstrating user scoping. |

## 5. Notes Endpoint

Commands:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' \
  'http://localhost:8088/index.php/apps/opsdash/overview/notes?range=week&offset=0'

curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST 'http://localhost:8088/index.php/apps/opsdash/overview/notes' \
  --data '{"range":"week","offset":0,"content":"<script>alert(\'note\')</script>"}'
```

Observations:
- POST succeeds (API accepts Basic auth + OCS header).
- Subsequent GET returns the raw string `"<script>alert('note')</script>"`. UI renders it as text (Vue auto-escapes), but it is stored unsanitized on the server. Track as informational; consider server-side escaping if other consumers render notes.

## 6. Local Storage Tampering

DevTools console:
```
localStorage.setItem('opsdash:theme-preference', '{"oops":true}')
location.reload()
```
The dashboard reloaded cleanly (console only shows standard Nextcloud warnings),
indicating `useThemeSync` normalises unexpected storage values.

## 7. Automation Script

Added `tools/security/run_curl_checks.sh` to replay clamps/auth guards/fuzz tests.
Run (admin creds) output:
```
=== Range clamp ===
"week"
=== Offset clamp ===
24
=== Unauthorized request ===
401
=== Missing OCS header / CSRF ===
412
=== Fuzz persist ===
10000
"<script>alert(1)</script>"
=== Notes injection ===
true
"<script>alert('note')</script>"
```

## 8. Import Envelope Fuzzing

`tools/security/import_fuzz.sh` mimics an exported config envelope (with
`missing-cal` and `evilKey`). It posts `.payload` to `/overview/persist` via curl
and prints `{warnings, theme_preference_read, targets_week_read}`. Current run:
no warnings, `theme_preference_read: "dark"`, `targets_week_read.personal: 12` —
showing extra keys are ignored while legitimate fields apply.

## 9. Outstanding
- Extend automation to cover `/overview/notes` with explicit CSRF token headers.
- Add browser automation (Playwright) for onboarding/preset UI to spot regressions visually.
