# Opsdash Pentest Plan (White-Box)

This plan defines how we will perform recurring white-box penetration tests on the
Opsdash Nextcloud app (0.4.5+). It combines static analysis of the PHP/Vue
codebase with dynamic testing inside a seeded dev stack.

## Objectives
- Verify controllers (`OverviewController`, notes, presets) enforce auth,
  authorization, CSRF, and input clamps as documented.
- Stress SPA persistence/import paths to surface XSS, CSRF, injection, and
  privilege-escalation issues.
- Exercise client/server state sync (theme, onboarding, sidebar payload) to spot
  desync vulnerabilities or logic bugs that leak data across users.
- Capture reproducible evidence (DevTools traces + curl scripts) for every
  finding.

## Scope
- **Server:** everything under `lib/` (especially `Controller/OverviewController.php`),
  config storage via `IConfig`, and DAV/color helper calls.
- **Client:** `src/` SPA, including sidebar import/export, onboarding wizard,
  theme sync, and storage usage (`localStorage`, `opsdash:theme-preference`).
- **Transport:** `/apps/opsdash/overview/*` routes (`load`, `persist`, `notes`,
  `presets*`). Requests happen inside the authenticated Nextcloud session; no
  anonymous access is in scope.
- **Out of scope:** Nextcloud core services outside Opsdash, third-party apps,
  and infrastructure (Docker host, database) unless an Opsdash bug is the root
  cause.

## Environment & Tooling
1. **Local NC stack** using the provided Docker compose file (NC 31 baseline).
   Seed calendars per `docs/SEEDING.md` for repeatable data.
2. **Browser DevTools** (Chromium/Firefox) for:
   - Console monitoring (`[opsdash] Vue error`, CSP warnings).
   - Network tab filtering `overview` requests; copy as cURL to replay.
   - Application tab → Storage → Local Storage (`opsdash.sidebarOpen`,
     `opsdash:theme-preference`) to test tampering.
   - Performance tab to capture timeline traces during stress tests.
3. **curl/httpie** for scripted requests. Template:
   ```bash
   export BASE="http://localhost:8088/index.php/apps/opsdash"
   export TOKEN="$(php ./tools/get_token.php admin)" # helper script or copy from DevTools
   curl -sS -b cookies.txt -c cookies.txt \
     -H "OCS-APIREQUEST: true" \
     -H "requesttoken: $TOKEN" \
     "$BASE/overview/load?range=week&offset=0"
   ```
   Use `-X POST -H 'Content-Type: application/json' --data @payload.json` for
   `/overview/persist` and `/overview/notes`.
4. **Static analysis helpers:**
   - `rg` for locating validation and sanitisation paths.
   - `php -l` and `npm run test` to ensure we stay green between attack tweaks.
5. **Automation:** `tools/security/run_curl_checks.sh` exercises range/offset clamps,
   auth failures, `/persist` fuzzing, preset sanitisation, and notes injection in
   one go (set `OPSDASH_BASE/USER/PASS`).
6. **Optional fuzzers:** Burp Suite intruder, OWASP ZAP, or custom scripts
   targeting known payload structures (`targets_config`, `presets`).

## Methodology
1. **Recon & Baseline**
   - Review `docs/SECURITY.md`, `APP_STORE_PUBLISHING.md`, and Config specs to
     understand intended constraints.
   - Map endpoints via `appinfo/routes.php` and controller methods.
   - Confirm CSRF token handling by intercepting a valid `/persist` request in
     DevTools and replaying without the token (should 403).

2. **Server-Side Testing**
   - **Authentication/Authorization:** ensure controllers check `NoAdminRequired`
     boundaries. Attempt to reuse cookies from another user to load/persist data.
   - **Input Validation:** craft payloads that push beyond limits (e.g., huge
     `targets_week`, invalid `theme_preference` values). Compare with clamps in
     `cleanTargets`, `cleanOnboardingState`, `sanitizeThemePreference`.
   - **Config Import Path:** upload envelopes via `/overview/persist` with
     unexpected keys to confirm ignored list and error messages.
   - **Presets:** test for path traversal or injection in preset names, large
     payloads, or conflicting IDs.
   - **Notes endpoint:** verify per-range isolation and CSRF enforcement. Try
     posting HTML/JS to detect stored XSS surfaces.

3. **Client-Side Testing**
   - Inspect `localStorage` keys. Attempt to change `opsdash:theme-preference` or
     `opsdash.sidebarOpen` to unexpected values (e.g., JSON string) before load;
     observe whether the SPA sanitises and persists erroneous data.
   - Use DevTools → Sources → pretty-print `main-*.js` to map stack traces to
     composables (source maps exist in dev builds). Confirm onboarding/theme
     watchers fail gracefully when storage is empty.
   - Trigger onboarding wizard repeatedly (Config & Setup → Re-run). Monitor the
     console for `[opsdash] Vue error`—no errors should appear now that
     `useOnboardingFlow` is in place. Document any regression with stack traces
     and network payloads.
   - Explore import/export UI: drop mutated payload files (extra keys, script
     tags) and ensure the SPA reports ignored keys without executing content.

4. **Business Logic Abuse**
   - **Range/Offset flooding:** use curl to request `offset=999` or `range=year`
     (unsupported) and confirm the backend clamps to safe ranges.
   - **Simulated concurrency:** send overlapping `/persist` requests (e.g., theme
     toggle + sidebar edits) and watch for dropped fields. Validate the SPA’s
     merge logic keeps `balance.ui.showNotes` intact.
   - **Multi-user bleed:** create two NC users; confirm stored configs remain
     user-scoped by replaying `admin`’s payload as `user2`.

5. **Negative Testing & Hardening Checks**
   - Remove `requesttoken` header or replay with stale tokens to verify CSRF
     enforcement.
   - Attempt to inject `<script>` inside category labels or notes; review DOM via
     DevTools Elements to ensure Vue escapes content.
   - Inspect response headers (DevTools → Network → Headers) for CSP and cookies
     (`HttpOnly`, `SameSite`). Document any missing protections to address in the
     Nextcloud host config.

## Using DevTools Effectively
1. Open DevTools (F12) once logged in.
2. **Console tab:** filter by `opsdash` to spot runtime warnings. Copy stack
   traces and map them back to TypeScript using the `Sources` tab (use the
   `webpack://`/`vite://` sources if sourcemaps are available).
3. **Network tab:** enable “Preserve log”. Reload the dashboard to capture
   `/overview/load` and `/overview/persist`. Right-click → “Copy as cURL” for
   later reproduction.
4. **Application tab:** under Storage → Local Storage → `http://localhost`, edit
   `opsdash:theme-preference` and reload to observe sync behaviour. Use this to
   test resilience to corrupted client state.
5. **Sources tab:** set breakpoints inside `src/App.vue` or composables to watch
   how payloads are merged. Helpful when fuzzing import/export logic.

## Crafting curl Requests
1. Export cookies from the browser (`cookies.txt`). DevTools → Application →
   Cookies → right-click → Export, or use `curl -c` to capture once logged in.
2. Grab the `requesttoken` from DevTools (Network tab → Headers). The token is
   per-response; update it when the session refreshes.
3. Example POST fuzz template:
   ```bash
   cat > fuzz.json <<'EOF'
   {
     "cals": ["9999"],
     "groups": {"9999": 2147483647},
     "targets_week": {"9999": -123},
     "targets_month": {"9999": 999999999},
     "targets_config": {"balance": {"ui": {"showNotes": true}}},
     "theme_preference": "purple"
   }
   EOF

   curl -sSi -b cookies.txt -c cookies.txt \
     -H "OCS-APIREQUEST: true" \
     -H "requesttoken: $TOKEN" \
     -H "Content-Type: application/json" \
     -X POST "$BASE/overview/persist" \
     --data @fuzz.json
   ```
   Observe the JSON response for sanitised values (`targets_week_read`,
   `theme_preference_read`).

## Reporting & Tracking
- Document each finding with:
  - **Title / CWE** reference.
  - **Environment:** commit, NC version, dataset.
  - **Steps:** DevTools console/network copy, curl commands, payloads.
  - **Impact + Suggested Fix.**
- Store reports under `docs/SECURITY.md` appendices or the internal tracker.
- Re-run the pentest checklist after every release (0.4.x) or significant
  refactor (e.g., architecture splits, NC 32 line).

## Next Actions
- Automate curl-based smoke scripts (`tools/security/`) to catch regressions in
  CI.
- Integrate DevTools protocol automation (Puppeteer/Playwright) for repeated XSS
  checks.
- Schedule quarterly white-box reviews aligned with roadmap milestones (P1
  frontend structure, P2 server caching).
