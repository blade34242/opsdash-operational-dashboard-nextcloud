name: Nextcloud Server Tests

on:
  push:
    branches:
      - master
      - 'release/**'
  pull_request:

env:
  APP_NAME: opsdash
  PLAYWRIGHT_SECOND_USER: qa
  PLAYWRIGHT_SECOND_PASS: qa-secret

jobs:
  matrix-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.load-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - id: load-matrix
        run: |
          matrix=$(node .github/scripts/render-matrix.js)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  server-tests:
    needs: matrix-config
    name: Nextcloud ${{ matrix.nextcloud_branch }} / PHP ${{ matrix.php_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix-config.outputs.matrix) }}
    steps:
      - name: Checkout Nextcloud server
        uses: actions/checkout@v4
        with:
          repository: nextcloud/server
          ref: ${{ matrix.nextcloud_branch }}
          submodules: true
          path: server

      - name: Checkout app sources
        uses: actions/checkout@v4
        with:
          path: app-src

      - name: Sync app into server tree
        run: |
          mkdir -p server/apps/${{ env.APP_NAME }}
          rsync -a --delete app-src/opsdash/ server/apps/${{ env.APP_NAME }}/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: NPM install
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm ci

      - name: NPM unit tests
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm run test -- --run

      - name: Build assets
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm run build

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: mbstring, intl, gd
          coverage: none

      - name: Composer install
        working-directory: server/apps/${{ env.APP_NAME }}
        run: composer install

      - name: Install Nextcloud
        working-directory: server
        run: |
          mkdir -p data
          php occ maintenance:install --database=sqlite --database-name=nextcloud --admin-user admin --admin-pass admin
          php occ app:enable $APP_NAME

      - name: Create secondary user
        working-directory: server
        env:
          SECOND_USER: ${{ env.PLAYWRIGHT_SECOND_USER }}
          SECOND_PASS: ${{ env.PLAYWRIGHT_SECOND_PASS }}
          OC_PASS: ${{ env.PLAYWRIGHT_SECOND_PASS }}
        run: |
          php occ user:add --password-from-env --display-name="QA Opsdash" "$SECOND_USER"
          php occ user:setting "$SECOND_USER" opsdash selected_cals "opsdash-focus"

      - name: PHPUnit
        working-directory: server/apps/${{ env.APP_NAME }}
        run: composer run test:unit

      - name: Install Playwright deps
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npx playwright install --with-deps chromium

      - name: Start PHP server
        working-directory: server
        run: |
          php -S 127.0.0.1:8080 -t . >/tmp/php-server.log 2>&1 &
          echo $! > /tmp/php-server.pid

      - name: Playwright smoke test
        working-directory: server/apps/${{ env.APP_NAME }}
        env:
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:8080
          PLAYWRIGHT_USER: admin
          PLAYWRIGHT_PASS: admin
          PLAYWRIGHT_SECOND_USER: ${{ env.PLAYWRIGHT_SECOND_USER }}
          PLAYWRIGHT_SECOND_PASS: ${{ env.PLAYWRIGHT_SECOND_PASS }}
        run: npm run test:e2e

      - name: Upload Playwright results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.nextcloud_branch }}-php${{ matrix.php_version }}
          path: server/apps/${{ env.APP_NAME }}/playwright-report
          if-no-files-found: ignore

      - name: Stop PHP server
        if: always()
        run: |
          if [ -f /tmp/php-server.pid ]; then
            kill $(cat /tmp/php-server.pid) || true
          fi
          rm -f /tmp/php-server.pid
