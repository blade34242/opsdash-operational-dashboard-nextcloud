name: Nextcloud Server Tests

on:
  push:
    branches:
      - master
      - 'release/**'
  pull_request:

env:
  APP_NAME: opsdash
  NEXTCLOUD_BRANCH: stable31

jobs:
  server-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Nextcloud server
        uses: actions/checkout@v4
        with:
          repository: nextcloud/server
          ref: ${{ env.NEXTCLOUD_BRANCH }}
          submodules: true
          path: server

      - name: Checkout app
        uses: actions/checkout@v4
        with:
          path: server/apps/${{ env.APP_NAME }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: NPM install
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm ci

      - name: NPM unit tests
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm run test -- --run

      - name: Build assets
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npm run build

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, gd
          coverage: none

      - name: Composer install
        working-directory: server/apps/${{ env.APP_NAME }}
        run: composer install

      - name: Install Nextcloud
        working-directory: server
        run: |
          mkdir -p data
          php occ maintenance:install --database=sqlite --database-name=nextcloud --admin-user admin --admin-pass admin
          php occ app:enable $APP_NAME

      - name: PHPUnit
        working-directory: server/apps/${{ env.APP_NAME }}
        run: composer run test:unit

      - name: Install Playwright deps
        working-directory: server/apps/${{ env.APP_NAME }}
        run: npx playwright install --with-deps chromium

      - name: Start PHP server
        working-directory: server
        run: |
          php -S 127.0.0.1:8080 -t . >/tmp/php-server.log 2>&1 &
          echo $! > /tmp/php-server.pid

      - name: Playwright smoke test
        working-directory: server/apps/${{ env.APP_NAME }}
        env:
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:8080
          PLAYWRIGHT_USER: admin
          PLAYWRIGHT_PASS: admin
        run: npm run test:e2e

      - name: Upload Playwright results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: server/apps/${{ env.APP_NAME }}/playwright-report
          if-no-files-found: ignore

      - name: Stop PHP server
        if: always()
        run: |
          if [ -f /tmp/php-server.pid ]; then
            kill $(cat /tmp/php-server.pid) || true
          fi
          rm -f /tmp/php-server.pid
