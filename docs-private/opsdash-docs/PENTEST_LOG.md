# Opsdash Pentest Log — 2025-11-10

All commands executed from repo root (unless noted). Credentials:
- `admin:admin`
- `pentester:pentest` (created via `occ` for multi-user isolation tests).

> Note: The scripts referenced below (`tools/security/run_curl_checks.sh`,
> `tools/security/import_fuzz.sh`, `opsdash/tools/security/run_notes_csrf.sh`)
> run manually during pentests; they are not part of the default CI pipeline.

## 1. Baseline & Input Clamps

| Test | Command | Result |
| ---- | ------- | ------ |
| Invalid `range` clamped to `week` | `curl -s -u admin:admin -H 'OCS-APIREQUEST: true' 'http://localhost:8088/index.php/apps/opsdash/overview/load?range=year&offset=0' \\| jq '.meta.range'` | Response `"week"` (server rejects unsupported range). |
| Oversized `offset` clamped | `curl -s -u admin:admin -H 'OCS-APIREQUEST: true' '...offset=999' \\| jq '.meta.offset'` | Response `24` (server max +/-24). |
| Unauthenticated load blocked | `curl -i '.../overview/load?range=week&offset=0'` | `401 Unauthorized`. |
| POST `/persist` without `OCS-APIREQUEST` header | `curl -i -s -u admin:admin -H 'Content-Type: application/json' -X POST ... --data '{}'` | `412 Precondition failed` (CSRF/OCS guard). |

## 2. `/persist` Fuzz

Payload (`fuzz.json`) attempted negative targets, huge totals, invalid `theme_preference`, and HTML in category IDs:
```json
{
  "cals": ["personal"],
  "groups": {"personal": 999},
  "targets_week": {"personal": -123},
  "targets_month": {"personal": 987654321},
  "targets_config": {
    "categories": [
      {"id": "<script>alert(1)</script>", "label": "<img src=x onerror=alert(1)>", "targetHours": -50, "includeWeekend": true}
    ],
    "totalHours": 100000,
    "balance": {"ui": {"showNotes": true}}
  },
  "theme_preference": "purple"
}
```
Command:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST 'http://localhost:8088/index.php/apps/opsdash/overview/persist' \
  --data @fuzz.json | jq '.'
```
Findings:
- Numeric clamps engaged (`targets_week`→0, `targets_month`→10000, `totalHours`→10000).
- Invalid `theme_preference` ignored (remains `auto`).
- HTML payload stored verbatim; SPA escapes at render time (no execution observed).

## 3. Presets Endpoint

`preset_payload.json` (`name = "evil<script>"`) saved successfully:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST '.../overview/presets' --data @preset_payload.json
```

Prior to the 0.4.5 fix, loading via `/overview/presets/evil%3Cscript%3E` returned
HTTP 500. The new sanitiser strips HTML/path characters so the preset is stored
as `evilscript`. Follow-up GET/DELETE succeed and the automation script asserts
this behaviour on every run.

## 4. Multi-user Isolation

Created second user:
```
docker exec nc31-dev sh -c 'OC_PASS=pentest php occ user:add \
  --password-from-env --display-name="Pentester" --email="pentester@example.com" pentester'
```

| Test | Result |
| ---- | ------ |
| `pentester` `/overview/load` | Returns `1` calendar (personal only), confirming empty config. |
| `pentester` `/overview/persist` (custom payload) | `{"ok":true}`; only their dataset changes. |
| Re-fetch `admin` | Still shows 8 calendars + original config, demonstrating user scoping. |

## 5. Notes Endpoint

Commands:
```
curl -s -u admin:admin -H 'OCS-APIREQUEST: true' \
  'http://localhost:8088/index.php/apps/opsdash/overview/notes?range=week&offset=0'

curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST 'http://localhost:8088/index.php/apps/opsdash/overview/notes' \
  --data '{"range":"week","offset":0,"content":"<script>alert(\'note\')</script>"}'
```

Observations:
- POST succeeds (API accepts Basic auth + OCS header).
- Subsequent GET returns the raw string `"<script>alert('note')</script>"`. UI renders it as text (Vue auto-escapes), but it is stored unsanitized on the server. Track as informational; consider server-side escaping if other consumers render notes.

## 6. Local Storage Tampering

DevTools console:
```
localStorage.setItem('opsdash.sidebarOpen', '{"oops":true}')
location.reload()
```
The dashboard reloaded cleanly (console only shows standard Nextcloud warnings),
indicating the SPA normalises unexpected storage values. Theme preference is server-persisted and should not be driven by localStorage.

## 7. Automation Script

Added `tools/security/run_curl_checks.sh` to replay clamps/auth guards/fuzz tests.
Run (admin creds) output:
```
=== Range clamp ===
"week"
=== Offset clamp ===
24
=== Unauthorized request ===
401
=== Missing OCS header / CSRF ===
412
=== Fuzz persist ===
10000
"<script>alert(1)</script>"
=== Notes injection ===
true
"<script>alert('note')</script>"
```

## 8. Import Envelope Fuzzing

`tools/security/import_fuzz.sh` mimics an exported config envelope (with
`missing-cal` and `evilKey`). It posts `.payload` to `/overview/persist` via curl
and prints `{warnings, theme_preference_read, targets_week_read}`. Current run:
no warnings, `theme_preference_read: "dark"`, `targets_week_read.personal: 12` —
showing extra keys are ignored while legitimate fields apply.

## 9. Outstanding
- Extend automation to cover `/overview/notes` with explicit CSRF token headers.
- Add browser automation (Playwright) for onboarding/preset UI to spot regressions visually.

## 10. DevTools session (2025-11-10)
- **Range + offset clamps from SPA context.** Used the browser console (via MCP devtools-ws) to run `fetch('/index.php/apps/opsdash/overview/load?range=year&offset=0', {headers:{'OCS-APIREQUEST':'true'}})` and `...offset=999`. Responses showed `meta.range === "week"` and `meta.offset === 24`, matching backend clamps when requests originate from the SPA itself.
- **Session-required POSTs.** `fetch('/index.php/apps/opsdash/overview/persist', {method:'POST', credentials:'omit', ...})` returned `401 {"message":"Current user is not logged in"}`, proving the endpoint rejects requests without authenticated cookies.
- **CSRF token enforcement.** Posting with default credentials but omitting/poisoning the `requesttoken` header returned `200` yet `theme_preference_saved` stayed `null`; nothing persisted. Supplying the in-page token (`window.OC.requestToken`) resulted in `theme_preference_saved: "light"`, confirming valid tokens are required for state changes even though the HTTP status remains 200.

## 11. CLI replay (2025-11-10)
- `tools/security/run_curl_checks.sh` has been updated to skip the HTML form login and hit the OCS API with basic auth (`curl -u admin:admin -H 'OCS-APIREQUEST: true'`). This avoids the Nextcloud 31 redirect loop and makes the script reproducible in CI/local runs.
- After the change the script prints the expected clamps and sanitation results (see console excerpt below) and exits 0.
- Independently re-ran each check manually with `curl -u admin:admin` to confirm behaviour:
  - Range clamp: `curl ...load?range=year` → `.meta.range == "week"`.
  - Offset clamp: `curl ...offset=999` → `.meta.offset == 24`.
  - Unauthorized GET without credentials returns `401`.
  - Missing `OCS-APIREQUEST` header on `POST /overview/persist` returns HTTP `412`.
  - Persist fuzz payload reports `targets_config_read.totalHours == 10000` and echoes the HTML id, confirming clamps + escaping expectations.
  - Preset sanitisation: payload named `evil<script>` is stored/returned as `evilscript`, delete call succeeds.
  - Notes endpoint: POST of `<script>alert('note')</script>` succeeds (`.ok == true`) and the subsequent GET returns the raw string, matching the SPA-escape behaviour recorded earlier.
- Copy of the script output for this run:

```
[security] Using basic auth to hit OCS API (establish cookie-less session)

=== Range clamp ===
"week"

=== Offset clamp ===
24

=== Unauthorized request ===
401

=== Missing OCS header / CSRF ===
412

=== Fuzz persist ===
10000
"<script>alert(1)</script>"

=== Preset sanitisation ===
Saved preset as: evilscript
"evilscript"
true

=== Notes injection ===
true
"<script>alert('note')</script>"
```

## 12. Additional automation (2025-11-10)
- `tools/security/import_fuzz.sh` remains stable: payload with `missing-cal` + `evilKey` triggers no warnings, keeps `theme_preference_read: "dark"`, and preserves legit targets. This confirms extra envelope keys are ignored while valid fields apply.
- `tools/security/preset_roundtrip.sh` exercises the full preset lifecycle (HTML name, missing calendars) and prints:
  ```
  Saved preset as: QAscript
  Warnings: [
    "Skipped unknown calendars: missing-cal"
  ]
  Loaded preset summary:
  {
    "preset": {
      "name": "QAscript",
      "selected": ["personal"],
      "warnings": []
    }
  }
  true
  ```

## 13. Widget tabs payload sanity (2025-11-10)

Manual curl (admin session) with malformed `widgets` payload:
```
cat > widgets-fuzz.json <<'EOF'
{
  "widgets": {
    "defaultTabId": "tab-999",
    "tabs": [
      { "id": "", "label": "<script>x</script>", "widgets": [{"id":"w1","type":"targets","layout":{"width":"giant","height":"xxl","order":"bad"},"version":1}] }
    ]
  }
}
EOF

curl -s -u admin:admin -H 'OCS-APIREQUEST: true' -H 'Content-Type: application/json' \
  -X POST 'http://localhost:8088/index.php/apps/opsdash/overview/persist' \
  --data @widgets-fuzz.json | jq '.widgets_saved'
```

Observed:
- Server stored a normalized payload (valid tab id, cleaned label, safe layout values).
- No console errors when reloading the dashboard; only the normalized tab rendered.
  proving sanitised names and load/delete flows behave as expected.
- `opsdash/tools/security/run_notes_csrf.sh` now uses basic auth to fetch `/overview`, scrape `window.OC.requestToken`, and POST a note with proper headers. Output:
  ```
  [notes-csrf] Using basic auth for API calls
  [notes-csrf] Token: iNWUcGDD...
  true
  "Automation note via CSRF script"
  ```
  This proves notes updates still require a valid token/header pair even when using REST clients.
- Next automation target: add a script that exercises preset import/export via curl (mirroring the SPA flow) and checks warnings and sanitisation responses end-to-end.

## 13. Additional pass (2025-12-11)
- Seeded calendars/Deck for multi-user isolation: created `qa`/`pentester`, seeded `opsdash-focus` via `tools/seed_week.sh` (BASE=8088) and Deck boards via `php /var/www/html/apps-extra/opsdash/tools/seed_deck_boards.php` inside `nc31-dev` for `admin/qa/pentester`. `check_multi_user.sh` now passes (admin→personal, pentester→personal+opsdash-focus).
- CSRF gap: new `tools/security/check_csrf_missing_token.sh` posts to `/overview/notes` without `requesttoken` and the note is stored (exit 1, logs stored payload). In-SPA `fetch` without token also writes `theme_preference`/`reporting_config` to `/persist`. High priority to enforce requesttoken on writes.
- Deck settings fuzz: invalid enums clamp, but booleans (`autoScroll`, `solvedIncludesArchived`) are forced true and huge `hiddenBoards` ids (e.g., 999999999) persist. Reporting config clamps invalid values as expected.
- Deck UI verified after re-enabling deck settings: 7 cards render (admin) with filters visible. Range stress `offset=24` returns `truncated=false`. DAV color probe script returns 405 but is non-fatal in its current form.
